<?php

function phorum_mod_stopforumspam_before_register($userdata) {
    global $PHORUM;

    $apikey = $PHORUM['mod_stopforumspam']['apikey'];
    if(!empty($apikey)) {
        $baseurl = "http://www.stopforumspam.com/api?";
        $args=array();
        if(!empty($PHORUM['mod_stopforumspam']['check_ip'])) {
            $args[]="ip=".$_SERVER['REMOTE_ADDR'];
        }
        if(!empty($PHORUM['mod_stopforumspam']['check_username'])) {
            $args[]="username=".$userdata['username'];
        }
        if(!empty($PHORUM['mod_stopforumspam']['check_username'])) {
            $args[]="username=".$userdata['username'];
        }
        if(count($args)) {
            include_once("./include/api/http_get.php");
            $error = array();
            // request serialized data
            $args[]="f=serial";
            $url = $baseurl.implode("&",$args);
            $res = phorum_api_http_get($url);
            if($res !== null) {
                $resdata = unserialize($res);
                foreach($resdata as $key => $var) {
                    if($key == 'success') {
                        if(empty($var)) {
                            // check failed, get out of here
                            _phorum_mod_stopforumspam_log('Check againt sfs api failed','The check against the stopforumspam.com API failed. We got no success message.\nData was:\n'.print_r($resdata,true));
                            break;
                        }
                    } else {
                        if(!empty($var['appears']) && $PHORUM['mod_stopforumspam']['block_action'] == 'blockerror') {
                            // block user
                            $error[]=$PHORUM['DATA']['LANG']['mod_stopforumspam']['error_'.$key];
                        } elseif(!empty($var['appears'])) {
                            if($userdata["active"] == PHORUM_USER_ACTIVE) {
                                $userdata['active'] = PHORUM_USER_PENDING_MOD;
                            } elseif($userdata["active"] == PHORUM_USER_PENDING_EMAIL) {
                                $userdata['active'] = PHORUM_USER_PENDING_BOTH;
                            }
                        }
                    }
                }
                if(count($error)) {
                    if($PHORUM['mod_stopforumspam']['block_action'] == 'blockerror') {
                        _phorum_mod_stopforumspam_log('User registration blocked!',"A user registration based on data from stopforumspam.com was blocked!\nUserdata was:\nUsername: {$userdata['username']}\nIP: {$_SERVER['REMOTE_ADDR']}\nEmail: {$userdata['email']}\n\nAnd data returned from Stopforumspam was:\n".print_r($resdata,true));
                    } else {
                        _phorum_mod_stopforumspam_log('User registration made unapproved!',"A user registration based on data from stopforumspam.com was made unapproved!\nUserdata was:\nUsername: {$userdata['username']}\nIP: {$_SERVER['REMOTE_ADDR']}\nEmail: {$userdata['email']}\n\nAnd data returned from Stopforumspam was:\n".print_r($resdata,true));
                    }
                    $userdata['error']=implode("<br />",$error);
                    $error = array();
                } else {
                    _phorum_mod_stopforumspam_log('User registration was safe',"A user registration was safe based on data from stopforumspam.com.\nUserdata was:\nUsername: {$userdata['username']}\nIP: {$_SERVER['REMOTE_ADDR']}\nEmail: {$userdata['email']}\n\nAnd data returned from Stopforumspam was:\n".print_r($resdata,true));

                }
            } else {
                _phorum_mod_stopforumspam_log('ERROR Check failed',"Data returned from Stopforumspam was:\n".print_r($res,true));

            }
        }
    }
    return $userdata;
}
function _phorum_mod_stopforumspam_log($shortmsg,$message) {
    global $PHORUM;
    if (!empty($PHORUM["mod_stopforumspam"]["log_events"]) &&
        function_exists('event_logging_writelog')) {
        event_logging_writelog(array(
            'message'   => $shortmsg,
            'details'   => $message,
            'loglevel'  => EVENTLOG_LVL_INFO
        ));
    }
}